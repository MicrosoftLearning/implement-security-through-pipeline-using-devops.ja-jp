---
lab:
  title: Azure Key Vault と Azure Pipelines の統合
  module: 'Module 6: Configure secure access to Azure Repos from pipelines'
---

# Azure Key Vault と Azure Pipelines の統合

Azure Key Vault は、キー、パスワード、証明書などの機密データの安全な保管と管理を行います。 Azure Key Vault では、ハードウェア セキュリティ モジュール、およびさまざまな暗号化アルゴリズムとキー長がサポートされています。 Azure Key Vault を使用すると、開発者がよく犯す間違いである、ソース コードを介した機密データ開示の可能性を最小限に抑えることができます。 Azure Key Vault にアクセスするには、コンテンツに対するきめ細かいアクセス許可をサポートする適切な認証と認可が必要です。

この演習は約 **30** 分かかります。

## 開始する前に

ラボに従うには、Azure サブスクリプション、Azure DevOps 組織、eShopOnWeb アプリケーションが必要です。

- 手順に [従ってラボ環境](APL2001_M00_Validate_Lab_Environment.md)を検証します。

## 手順

このラボでは、次の手順を使用して、Azure Key Vault を Azure Pipelines と統合する方法について説明します。

- ACR のパスワードをシークレットとして保存する Azure Key Vault を作成します。
- Azure Key Vault のシークレットにアクセスするための Azure サービス プリンシパルを作成します。
- サービス プリンシパルがシークレットを読み取れるようにするアクセス許可を構成します。
- Azure Key Vault からパスワードを取得し、それを後続のタスクに渡すようにパイプラインを構成します。

### 演習 1: CI パイプラインを設定して eShopOnWeb コンテナーをビルドする

次のために CI YAML パイプラインを設定します。

- コンテナー イメージを保持するための Azure コンテナー レジストリを作成する
- Docker Compose を使って **eshoppublicapi** と **eshopwebmvc** のコンテナー イメージをビルドしてプッシュする。 **eshopwebmvc** コンテナーのみがデプロイされます。

#### タスク 1: (完了している場合はスキップしてください) サービス プリンシパルを作成する

このタスクでは、Azure CLI を使ってサービス プリンシパルを作成します。これにより、Azure DevOps で次のことができるようになります。

- Azure サブスクリプションでリソースをデプロイします。
- 後で作成する Key Vault シークレットに対する読み取りアクセス権を取得する。

Azure Pipelines から Azure リソースをデプロイするには、サービス プリンシパルが必要です。 パイプラインでシークレットを取得するため、Azure キー コンテナーを作成するときにサービスにアクセス許可を付与する必要があります。

サービス プリンシパルは、パイプライン定義内から Azure サブスクリプションに接続するとき、またはプロジェクト設定ページから新しいサービス接続を作成するときに (自動オプション)、Azure パイプラインによって自動的に作成されます。 ポータルから、または Azure CLI を使用してサービス プリンシパルを手動で作成し、プロジェクト間で再利用することもできます。

1. ラボのコンピューターで Web ブラウザーを起動し、Azure Portal に移動します。このラボで使用する Azure サブスクリプションで所有者ロールがあり、このサブスクリプションに関連のある Azure AD テナントでグローバル管理者ロールがあるユーザー アカウントを使ってサインインします。

1. Azure portal で、ページ上部の検索テキストボックスのすぐ右側にある **Cloud Shell** アイコンをクリックします。

1. **Bash** または **PowerShell** の選択を求めるメッセージが表示されたら、**[Bash]** を選択します。

   > [!NOTE]
   > 注: Cloud Shell を初めて起動し、[ストレージがマウントされていません] というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、[ストレージの作成] を選択します。

1. **Bash** プロンプトの **[Cloud Shell]** ペインで、次のコマンドを実行して、Azure サブスクリプション ID とサブスクリプション名の属性の値を取得します。

    ```bash
    az account show --query id --output tsv
    az account show --query name --output tsv
    ```

    > [!NOTE]
    > 注:両方の値をテキスト ファイルにコピーします。 これらは、このラボの後半で必要になります。

1. **Bash** プロンプトの **Cloud Shell** ペインで、次のコマンドを実行してサービス プリンシパルを作成します (**myServicePrincipalName** を文字と数字で構成される一意の文字列に、**mySubscriptionID** をご自分の Azure subscriptionId に置き換えてください)。

    ```bash
    az ad sp create-for-rbac --name myServicePrincipalName \
                         --role contributor \
                         --scopes /subscriptions/mySubscriptionID
    ```

    > [!NOTE]
    > 注:このコマンドは JSON 出力を生成します。 出力をテキスト ファイルにコピーします。 このラボで後ほど必要になります。

1. 次に、Azure DevOps ポータル `https://dev.azure.com` に移動し、組織を開きます。

1. Azure DevOps Portal ( から EShopOnWeb プロジェクトに移動します。 **[プロジェクトの設定] > [サービス接続] ([パイプライン] の下)** 、 **[新しいサービス接続]** の順にクリックします。

    ![接続の作成ボタンのスクリーンショット。](media/new-service-connection.png)

1. **[新しいサービス接続]** ブレードで、 **[Azure Resource Manager]** と **[次へ]** を選択します (必要に応じて下にスクロールします)。

1. **[サービス プリンシパル (自動)]** を選択し、**[次へ]** を選択します。

1. 前の手順で収集した情報を使って、空のフィールドに入力します。
    - サブスクリプション ID と名前。
    - サービス プリンシパル ID (または clientId)、Key (または Password)、TenantId。
    - **[サービス接続名]** に「**azure subs**」と入力します。 この名前は、Azure サブスクリプションと通信するために Azure DevOps サービス接続が必要になるときに、YAML パイプラインで参照されます。

        ![接続済みサービスの構成のスクリーンショット。](media/azure-service-connection.png)

1. [すべてのパイプラインへのアクセス許可を与える] : **確認して保存する** を選択します。

    > [!NOTE]
    > 運用環境では、 **すべてのパイプラインにアクセス許可を** 付与するオプションは推奨されません。 このラボでは、パイプラインの構成を簡略化するためにのみ使用されます。

#### タスク 2: CI パイプラインのセットアップと実行

このタスクでは、既存の CI YAML パイプライン定義をインポートし、変更して実行します。 新しい Azure Container Registry (ACR) を作成し、eShopOnWeb コンテナー イメージをビルドして発行します。

1. Azure DevOps ポータル `https://dev.azure.com` に移動し、組織を開きます。

1. Azure DevOps Portal ( から EShopOnWeb プロジェクトに移動します。 **[パイプライン] > [パイプライン]** に移動し、 **[パイプラインを作成]** (または **[新しいパイプライン]** ) をクリックします。

1. **[コードはどこにありますか?]** ウィンドウで、 **[Azure Repos Git (YAML)]** を選択し、**eShopOnWeb** リポジトリを選択します。

1. **[構成]** セクションで、 **[既存の Azure Pipelines YAML ファイル]** を選択します。 次のパス **/.ado/eshoponweb-ci-dockercompose.yml** を指定し、 **[続行]** をクリックします。

    ![YAML ファイルからの [パイプライン] の選択のスクリーンショット。](media/select-ci-container-compose.png)

1. YAML パイプライン定義の変数セクションで、AZ400-EWebShop-NAME** をユーザー設定の名前 (rg-eshoponweb** など**) に置き換えて**リソース グループ名をカスタマイズし、YOUR-SUBSCRIPTION-ID を**独自の Azure subscriptionId に置き換え**、ユーザー設定の場所 (例: **southcentralus**) に最も近い場所を選択します。

1. (省略可能)前のラボで作成したセルフホステッド エージェントを使用して、Microsoft でホストされているエージェントに現在設定されているプール名を、作成したエージェント プールの名前 eShopOnWebSelfPool **** に更新できます。

    代替案:

    ```YAML
      - job: Build
        pool:
          vmImage: ubuntu-latest
    
    ```

    以下を使用します:

    ```YAML
      - job: Build
        pool: eShopOnWebSelfPool
    
    ```

    > [!NOTE]
    > セルフホステッド エージェントを使用してパイプラインを実行するには、エージェントを実行し、すべての前提条件 (ソリューションをビルドするための Visual Studio など) をインストールする必要があります。 前提条件がインストールされていない場合は、Microsoft ホステッド エージェントを使用できます。

1. **[保存]** を選択してメイン ブランチに直接コミットするか、このコミット用に新しいブランチを作成します。

1. もう一度 **[保存および実行]** を選択します。

    > [!NOTE]
    > 新しいブランチを作成する場合は、変更を メイン ブランチにマージするプル要求を作成する必要があります。

1. パイプラインを開きます。 重要: [This pipeline needs permission to access resources before this run can continue to Docker Compose to ACI] (ACI への Docker Compose に対してこの実行を続けるには、まずこのパイプラインにリソースにアクセスするためのアクセス許可が必要です) というメッセージが表示された場合は、[表示]、[許可]、さらにもう一度 [許可] をクリックします。 この操作は、パイプラインでリソースを作成するために必要です。

    ![YAML パイプラインからのアクセス許可のスクリーンショット。](media/pipeline-permit-resource.png)

1. ビルドが完了するまでに数分かかる場合があり、パイプラインが実行されるまで待ちます。 ビルドの定義は以下のタスクで構成されます。
      - **AzureResourceManagerTemplateDeployment** は、**bicep** を使用して Azure Container Registry をデプロイします。
      - **PowerShell** タスクは bicep 出力 (acr ログイン サーバー) を受け取り、パイプライン変数を作成します。
      - **DockerCompose** タスクは、eShopOnWeb のコンテナー イメージをビルドし、Azure Container Registry にプッシュします。

1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、名前を変更しましょう。

1. **最近作成したパイプラインの Pipelines > Pipelines** に移動し、実行されたパイプラインにマウス ポインターを置き、省略記号と**名前の変更/移動**オプションを選択します。

1. **eshoponweb-ci-dockercompose** という名前を付け、 **[保存]** をクリックします。

1. 実行が完了したら、Azure Portal で、以前に定義したリソース グループを開き、パイプラインによってデプロイされた Azure Container Registry (ACR) を表すエントリを選択します。

    > [!NOTE]
    > レジストリ内のリポジトリを表示するには、そのようなアクセスを提供するロールを割り当てる必要があります。 この目的のために、AcrPull ロールを使用します。

1. **[アクセスの制御 (IAM)]** ページで、 **[+ 追加]** を選択した後、ドロップダウン メニューで **[ロール割り当ての追加]** を選択します。

1. [ロールの**割り当ての**追加] ページの **[ロール**] タブで、[AcrPull **] を選択**し、[次へ **] を選択**します。

1. [メンバー **] **タブで、[+ メンバー**の選択] をクリックし**、ユーザー アカウントを選択し、[選択 **] をクリックして、[次へ **] を選択**します**。

1. [確認と割り当て]** を選択**し、割り当てが正常に完了したら、ブラウザー ページを更新します。

1. [コンテナー レジストリ] ページに戻り、左側の垂直メニュー バーの [サービス **] **セクションで [リポジトリ **] を選択**します。

1. レジストリに eshoppublicapi** と **eshopwebmvc** のイメージ**が含まれていることを確認します。 デプロイ フェーズでは **eshopwebmvc** のみを使用します。

    ![Azure portal の [新しいコンテナーの作成] ページのスクリーンショット。](media/azure-container-registry.png)

1. [アクセス キー] をクリックし、パスワードの値をコピーします。これは次のタスクで、Azure Key Vault のシークレットとして保持するために使用します。

    ![[アクセス キー] 設定の ACR パスワードのスクリーンショット。](media/acr-password.png)

#### タスク 3: Azure Key Vault を作成する

このタスクでは、Azure portal を使用して Azure Key Vault を作成します。

このラボ シナリオでは、Azure Container Registry (ACR) に格納されているコンテナー イメージをプルして実行する Azure Container Instance (ACI) を使用します。 ACR のパスワードをシークレットとしてキー コンテナーに保存します。

1. Azure portal の **[リソース、サービス、ドキュメントの検索]** テキスト ボックスに「**Key Vault**」と入力し、**Enter** キーを押します。

1. **[キー コンテナー]** ブレードを選択し、 **[作成] > [キー コンテナー]** をクリックします。

1. **[キー コンテナーの作成]** ブレードの **[基本]** タブで、次の設定を指定して **[次へ]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | Resource group | リソース グループ名 **rg-eshoponweb** |
    | キー コンテナー名 | **ewebshop-kv-NAME** などの一意の有効な名前 (NAME を置き換えてください) |
    | リージョン | ラボ環境の場所に近い Azure リージョン |
    | Pricing tier | **Standard** |
    | 削除されたボールトを保持する日数 | **7** |
    | 消去保護 | **消去保護を無効にする** |

1. [キー コンテナー**の作成] **ブレードの **[アクセス構成**] タブの [アクセス許可モデル **] **セクションで、[コンテナー アクセス ポリシー **] を選択**します。 

1. [アクセス ポリシー] **セクションで**、[+ 作成 **] を選択**して新しいポリシーを設定します。

    > **注**:許可されたアプリケーションとユーザーのみを許可することにより、Key Vault のアクセスを保護する必要があります。 コンテナーからデータにアクセスするには、パイプラインでの認証に使用する以前に作成したサービス プリンシパルに、読み取り (取得/一覧表示) アクセス許可を付与する必要があります。

    - **[アクセス許可]** ブレードで、 **[シークレットのアクセス許可]** の下にある **[取得]** と **[一覧表示]** のアクセス許可をオンにします。 [**次へ**] を選択します。
    - **[プリンシパル]** ブレードで、指定した Id または Name を使って、**以前に作成したサービス プリンシパル**を検索します。 **次へ** を選択し、再度 **次へ** を選択します
    - **[確認および作成]** ブレードで、**[作成]** を選択します。

1. **[キー コンテナーの作成]** ブレードに戻り、 **[確認と作成] > [作成]** をクリックします

    > [!NOTE]
    > 注:Azure Key Vault がプロビジョニングされるのを待ちます。 これにかかる時間は 1 分未満です。

1. **[デプロイが完了しました]** パネルで、**[リソースに移動]** を選択します。

1. Azure Key Vault ブレードのブレードの左側にある垂直メニューの **[オブジェクト]** セクションで、**[シークレット]** をクリックします。

1. **[シークレット]** ペインで、 **[+ 生成/インポート]** を選択します。

1. **[シークレットの作成]** ブレードで、次の設定を指定し、 **[作成]** をクリックします (他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | Upload options | **手動** |
    | 名前 | **acr-secret** |
    | 値 | 前のタスクでコピーした ACR アクセス パスワード |

#### タスク 3: Azure Key Vault に接続された変数グループを作成する

このタスクでは、Azure DevOps に変数グループを作成します。それは、サービス接続 (サービス プリンシパル) を使って、Key Vault から ACR パスワード シークレットを取得します

1. Azure DevOps ポータル `https://dev.azure.com` に移動し、組織を開きます。

1. Azure DevOps Portal ( から EShopOnWeb プロジェクトに移動します。

1. Azure DevOps ポータルの垂直ナビゲーション ウィンドウで、 **[パイプライン] > [ライブラリ]** を選択します。 **[+ Variable group]** を選択します。

1. **[新しい変数グループ]** ブレードで、次の設定を指定します。

    | 設定 | 値 |
    | --- | --- |
    | 変数グループ名 | **eshopweb-vg** |
    | シークレットを Azure KV からリンクする ... | **enable** |
    | Azure サブスクリプション | **[利用可能な Azure サービス接続] > [Azure subs]** |
    | キー コンテナー名 | キー コンテナー名|

1. **[変数]** の下の **[+ 追加]** をクリックし、**acr-secret** シークレットを選択します。 **[OK]** を選択します。

1. **[保存]** を選択します。

    ![変数グループの作成のスクリーンショット。](media/vg-create.png)

#### タスク 4: CD パイプラインをセットアップして Azure Container Instance (ACI) にコンテナーをデプロイする

このタスクでは、CD パイプラインをインポートし、カスタマイズして、前に作成したコンテナー イメージを Azure Container Instance にデプロイするために実行します。

1. Azure DevOps ポータル `https://dev.azure.com` に移動し、組織を開きます。

1. Azure DevOps Portal ( から EShopOnWeb プロジェクトに移動します。 **[パイプライン]** に移動し、**[新しいパイプライン]** を選択します。

1. **[コードはどこにありますか?]** ウィンドウで、 **[Azure Repos Git (YAML)]** を選択し、**eShopOnWeb** リポジトリを選択します。

1. **[構成]** セクションで、 **[既存の Azure Pipelines YAML ファイル]** を選択します。 次のパス **/.ado/eshoponweb-cd-aci.yml** を指定し、 **[続行]** をクリックします。

1. YAML パイプライン定義で、次をカスタマイズします。

    - **YOUR-SUBSCRIPTION-ID** を使用する Azure サブスクリプション ID にします。
    - **az400eshop-NAME** の NAME を置き換えて、グローバルに一意にします。
    - **YOUR-ACR.azurecr.io** と **ACR-USERNAME** を使用する ACR ログイン サーバーにします (どちらも ACR 名が必要です。[ACR] > [アクセス キー] で確認できます)。
    - **rg-az400-container-NAME** をラボで前に定義したリソース グループ名にします。

1. **[保存および実行]** をクリックし、パイプラインが正常に実行されるまで待ちます。

    > **注**: デプロイが完了するまでに数分かかる場合があります。 CD の定義は以下のタスクで構成されます。
    - **リソース** : CI パイプラインの完了に基づいて自動的にトリガーされるように準備されています。 また、bicep ファイルのリポジトリもダウンロードします。
    - **変数 (デプロイ ステージ用)** は変数グループに接続して、Azure Key Vault シークレット **acr-secret** を使用します
    - **AzureResourceManagerTemplateDeployment** は、bicep テンプレートを使用して Azure Container Instance (ACI) をデプロイし、ACR ログイン パラメーターを指定して、ACI が以前に作成したコンテナー イメージを Azure Container Registry (ACR) からダウンロードできるようにします。

1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、名前を変更しましょう。

1. Pipelines > Pipelines** に移動し**、最近作成したパイプラインを選択し、省略記号を選択して、[名前の変更/移動 **] オプションを選択**します。

1. **eshoponweb-cd-aci** という名前を付け、 **[保存]** をクリックします。

### 演習 2:Azure ラボ リソースを削除する

1. Azure portal で、作成したリソース グループを開き、 **[リソース グループの削除]** をクリックします。

    ![[リソース グループ削除] ボタンのスクリーンショット。](media/delete-resource-group.png)

    > [!WARNING]
    > 新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 使用していないリソースを削除することで、予期しない料金が発生しなくなります。

## 確認

このラボでは、次の手順を使用して、Azure KeyVault を Azure DevOps パイプラインと統合しました。

- Azure サービス プリンシパルを作成して Azure Key Vault のシークレットへのアクセスを提供し、Azure DevOps から Azure へのデプロイを認証しました。
- Git リポジトリからインポートした 2 つの YAML パイプラインを実行しました。
- ADO 変数グループを使って Azure Key Vault からパスワードを取得し、それを後続のタスクで使用するようにパイプラインを構成しました。
