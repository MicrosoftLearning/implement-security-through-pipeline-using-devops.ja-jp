---
lab:
  title: セキュリティで保護されたパイプライン用にエージェントとエージェント プールを構成する
  module: 'Module 2: Configure secure access to pipeline resources'
---

# セキュリティで保護されたパイプライン用にエージェントとエージェント プールを構成する

このラボでは、Azure DevOps エージェントとエージェント プールを構成し、それらのプールのアクセス許可を管理する方法について学習します。 Azure DevOps エージェント プールには、ビルドおよびリリース パイプラインを実行するためのリソースが用意されています。

この演習には、約 **25** 分かかります。

## 開始する前に

ラボの演習を行うには、Azure サブスクリプション、Azure DevOps 組織、eShopOnWeb アプリケーションが必要です。

- 手順に従って[ラボ環境を検証](APL2001_M00_Validate_Lab_Environment.md)します。

## 手順

エージェントを作成し、Windows を使用してセルフホステッド エージェントを構成します。 Linux または macOS でエージェントを構成する場合は、[Azure DevOps ドキュメント](https://docs.microsoft.com/azure/devops/pipelines/agents/v2-linux)の手順を行います。

構成時は、次の点に注意してください。

- **プロジェクトごとに個別のエージェントを維持する**: 各エージェントは、1 つのプールにのみ関連付けることができます。 プロジェクト間でエージェント プールを共有すると、インフラストラクチャ コストを節約できますが、横移動のリスクも生じます。 そのため、相互感染を防ぐために、プロジェクトごとに専用エージェントを含む個別のエージェント プールを用意することをお勧めしています。
- **特権の低いアカウントを使用してエージェントを実行する**: Azure DevOps リソースに直接アクセスできる ID でエージェントを実行すると、セキュリティ上の脅威が発生する可能性があります。 Network Service などの特権のないローカル アカウントでエージェントを操作することをお勧めします。これにより、リスクが最小限に抑えられます。
- **誤解を招くグループ名に注意する**: Azure DevOps の「プロジェクト コレクション サービス アカウント」グループは潜在的なセキュリティ リスクがあります。 このグループの一部であり、Azure AD によってサポートされている ID を使用してエージェントを実行すると、Azure DevOps 組織全体のセキュリティが危険にさらされる可能性があります。
- **セルフホステッド エージェントに高い特権のアカウントを使用しないようにする**: 高い特権のアカウントを使用してセルフホステッド エージェントを実行すると、特にシークレットや運用環境にアクセスする場合、パイプラインが侵害されたときにシステムが重大な脅威にさらされる可能性があります。
- **セキュリティに優先順位を付ける**: システムを保護するには、最小限の特権アカウントを使用してセルフホステッド エージェントを実行します。 たとえば、お使いのマシンのアカウントやマネージド サービス ID を使用してください。 また、Azure Pipelines がシークレットと環境へのアクセスを処理できるようにすることもお勧めします。

### 演習 1: エージェントを作成し、エージェント プールを構成する

この演習では、Azure 仮想マシン (VM) を作成し、それを使ってエージェントを作成し、エージェント プールを構成します。

#### タスク 1:Azure VM を作成して接続する

1. ブラウザーで Azure Portal (`https://portal.azure.com`) を開きます。 プロンプトが表示されたら、Azure サブスクリプションの所有者ロールを持つアカウントを使ってサインインします。

1. **[リソース、サービス、ドキュメントの検索 (G+/)]** ボックスに「**Virtual Machines**」と入力し、ドロップダウン リストからそれを選びます。

1. **[作成]** ボタンを選択します。

1. **[構成が事前設定された Azure 仮想マシン]** を選びます。

    ![構成が事前設定された仮想マシンの作成のスクリーンショット。](media/create-virtual-machine-preset.png)

1. ワークロード環境として **[Dev/Test]** を選び、ワークロードの種類として **[汎用]** を選びます。

1. **[VM の作成を続行する]** ボタンを選び、**[基本]** タブで次の操作を実行し、**[管理]** を選びます。

   | 設定 | アクション |
   | -- | -- |
   | **[サブスクリプション]** ドロップダウン リスト | Azure サブスクリプションを選択します。 |
   | **[リソース グループ]** セクション | **rg-eshoponweb-agentpool** という名前の新しいリソース グループを作成します。 |
   | **[仮想マシン名]** テキスト ボックス | 任意の名前を入力します (たとえば、**eshoponweb-vm**)。 |
   | **[リージョン]** ドロップダウン リスト | このラボで先ほど使ったものと同じ Azure リージョンを選びます。 |
   | **[可用性のオプション]** ドロップダウン リスト | **[インフラストラクチャ冗長は必要ありません]** を選択します。 |
   | **[セキュリティの種類]** ドロップダウン リスト | **[トラステッド起動の仮想マシン]** オプションを選びます。 |
   | **[イメージ]** ドロップダウン リスト | **Windows Server 2022 Datacenter: Azure Edition - x64 Gen2** イメージを選びます。 |
   | **[サイズ]** ドロップダウン リスト | テスト目的の場合は最も安価な **[Standard]** サイズを選びます。 |
   | **[ユーザー名]** テキスト ボックス | 任意のユーザー名を入力します |
   | **[パスワード]** テキスト ボックス | 任意のパスワードを入力します |
   | **[パブリック受信ポート]** セクション | **[選択したポートを許可する]** を選択します。 |
   | **[受信ポートを選択]** ドロップダウン リスト | **[RDP (3389)]** を選択します。 |

1. **[管理]** タブの **[ID]** セクションで、**[システム割り当てマネージド ID の有効化]** チェックボックスをオンにし、**[確認および作成]** を選びます。

1. **[確認および作成]** タブで、 **[作成]** を選択します。

   > [!NOTE]
   > プロビジョニング プロセスが完了するまで待ちます。 これには 2 分ほどかかります。

1. Azure portal で、新しく作成された Azure VM の構成が表示されるページに移動します。 

1. Azure VM ページで **[接続]** を選び、ドロップダウン メニューで **[接続]** を選びます。次に **[RDP ファイルのダウンロード]** を選び、ダウンロードした RDP ファイルを使って、Azure VM で実行されているオペレーティング システムへのリモート デスクトップ セッションを確立します。

#### タスク 2:エージェント プールを作成する

1. Azure VM へのリモート デスクトップ セッションで、Microsoft Edge Web ブラウザーを起動します。

1. Web ブラウザーで Azure DevOps ポータル (`https://dev.azure.com`) に移動し、サインインして組織にアクセスします。

1. **eShopOnWeb** プロジェクトを開き、左側の下部メニューから **[プロジェクトの設定]** を選びます。

1. **[パイプライン] > [エージェント プール]** で、**[プールの追加]** を選びます。

1. プールのタイプとして **[セルフホステッド]** を選びます。

1. エージェント プールの名前 (**eShopOnWebSelfPool** など) を指定し、オプションの説明を追加します。

1. **[すべてのパイプラインにアクセス権を付与する]** オプションをオフにします。

   ![セルフホステッド タイプのエージェント プールの追加オプションを示すスクリーンショット。](media/create-new-agent-pool-self-hosted-agent.png)

1. **[作成]** を選び、エージェント プールを作成します。

#### タスク 3:エージェントのインストール ファイルをダウンロードして展開する

1. Azure DevOps ポータルで、新しく作成したエージェント プールを選び、**[エージェント]** タブを選びます。

1. **[新しいエージェント]** を選び、新しいポップアップ ウィンドウの **[エージェントのダウンロード]** から **[ダウンロード]** を選びます。

   > [!NOTE]
   > インストール手順に従ってエージェントをインストールします。

1. PowerShell セッションを開始し、次のコマンドを実行して **agent** というフォルダーを作成します。

   ```powershell
   mkdir agent ; cd agent        
   ```

   > [!NOTE]
   > ユーザー プロファイルのルート フォルダー、またはエージェントをインストールするフォルダーを開いていることを確かめます。

1. 次のコマンドを実行し、ダウンロードしたエージェント インストーラー ファイルの内容を抽出します。

   ```powershell
   Add-Type -AssemblyName System.IO.Compression.FileSystem ; [System.IO.Compression.ZipFile]::ExtractToDirectory("$HOME\Downloads\vsts-agent-win-x64-3.232.0.zip", "$PWD")
   ```

   > [!NOTE]
   > エージェントを別の場所にダウンロードした場合 (またはダウンロードしたバージョンが異なる場合) は、上記のコマンドを適宜調整してください。

#### タスク 4:PAT トークンを作成する

> [!NOTE]
> エージェントを構成する前に、PAT トークンを作成する必要があります (既存のものがない場合)。 PAT トークンを作成するには、以下の手順を実行します。

1. Azure VM へのリモート デスクトップ セッション内で、別のブラウザー ウィンドウを開き、Azure DevOps ポータル (`https://dev.azure.com`) に移動し、組織にアクセスします。

1. 右側の上部メニュー (ユーザーのアバター アイコンのすぐ左) から **[ユーザー設定]** を選びます。

1. **[個人用アクセス トークン]** メニュー項目を選びます。

   ![[個人用アクセス トークン] メニューを示すスクリーンショット。](media/personal-access-token-menu.png)

1. **[新しいトークン]** を選びます。

1. トークンの名前を指定します (**eShopOnWebToken** など)。

1. トークンを使う Azure DevOps 組織を選びます。

1. トークンの有効期限を設定します (エージェントの構成にのみ使用されます)。

1. カスタム定義されたスコープを選択します。

1. すべてのスコープを表示する場合に選択します。

1. **エージェント プール (読み取りおよび管理)** スコープを選択します。

1. **[作成]** を選び、トークンを作成します。

1. トークンの値をコピーし、安全な場所に保存します (再度表示することはできません。 再生成できるのはトークンだけです)。

   ![個人用アクセス トークンの構成を示すスクリーンショット。](media/personal-access-token-configuration.png)

   > [!IMPORTANT]
   > 最小限の特権オプションである **[エージェント プール (読み取り、管理)]** は、エージェントの構成にのみ使います。 また、それがトークンの唯一の目的である場合は、トークンには必ず最短の有効期限を設定してください。 エージェントを再度構成する必要がある場合は、同じ特権を持つ別のトークンを作成できます。

#### タスク 5:エージェントの構成

1. Azure VM へのリモート デスクトップ セッション内で、PowerShell ウィンドウに戻ります。 必要に応じて、現在のディレクトリを、この演習で先ほどエージェント インストール ファイルを抽出したディレクトリに変更します。 

1. エージェントを無人で実行するように構成するには、次のコマンドを呼び出します。

   ```powershell
   .\config.cmd
   ```

   > [!NOTE]
   > エージェントを対話形式で実行する場合は、代わりに `.\run.cmd` を使います。 

1. エージェントを構成するには、プロンプトが表示されたら次のアクションを実行します。

   - Azure DevOps 組織の URL (**サーバー URL**) を `https://dev.azure.com/`{お客様の組織名} 形式で入力します。
   - 既定の認証の種類 (**PAT**) をそのまま使います。
   - 前の手順で作成した PAT トークンの値を入力します。
   - この演習で先ほど作成したエージェント プール名「**eShopOnWebSelfPool**」を入力します。
   - エージェント名「**eShopOnWebSelfAgent**」を入力します。
   - 既定のエージェント作業フォルダー (_work) をそのまま使います。
   - 「**Y**」と入力して、エージェントがサービスとして実行されるように構成します。
   - 「**Y**」と入力して、エージェント サービスの SERVICE_SID_TYPE_UNRESTRICTED を有効にします。
   - 「**NT AUTHORITY\SYSTEM**」と入力して、サービスのセキュリティ コンテキストを設定します。

   > [!IMPORTANT]
   > 一般にサービス セキュリティ コンテキストを構成するときは、最小限の特権の原則に従うようにします。

   - 既定のオプション (**N**) のままにして、構成の完了後すぐにサービスを開始できるようにします。

   ![エージェントの構成を示すスクリーンショット。](media/agent-configuration.png)

1. Azure DevOps ポータルを表示している Web ブラウザーに切り替え、エージェント プールに移動し、**[エージェント]** タブをクリックして、エージェントの状態を確認します。一覧に新しいエージェントが表示されます。

   ![エージェントの状態を示すスクリーンショット。](media/agent-status.png)

   > [!NOTE]
   > Windows エージェントの詳細については、「[セルフホステッド Windows エージェント](https://learn.microsoft.com/azure/devops/pipelines/agents/windows-agent)」をご覧ください。

   > [!IMPORTANT]
   > エージェントが Azure DevOps パイプラインから Azure リソースをビルドしてデプロイできるようにするには (今後のラボで手順を実行します)、エージェントをホストしている Azure VM のオペレーティング システム内に Azure CLI をインストールする必要があります。

1. Web ブラウザーを起動し、[[Windows に Azure CLI をインストールする]](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-windows?tabs=azure-cli#install-or-update) ページに移動します。

1. Azure CLI をダウンロードしてインストールします。 

1. Web ブラウザーで、Microsoft .NET 7.0 SDK インストーラー ページ (`https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-7.0.404-windows-x64-installer`) に移動します。

1. Microsoft .NET 7.0 SDK をダウンロードしてインストールします。

### 演習 2:エージェント プールのセキュリティを作成して構成する

この演習では、エージェント プールのセキュリティを構成します。

#### タスク 1: 新しいセキュリティ グループを作成する

1. Azure VM へのリモート デスクトップ セッション内で、Azure DevOps ポータルを表示している Web ブラウザーの **[プロジェクトの設定]** ペインの **[全般]** セクションにある **[アクセス許可]** を選びます。

1. **[新しいグループ]** を選びます。

1. グループの名前を指定します (**eShopOnWeb セキュリティ グループ**など)。

1. **[作成]** を選び、グループを作成します。

   ![セキュリティ グループの作成を示すスクリーンショット。](media/create-security-group.png)

#### タスク 2: セキュリティ グループを構成する

1. Azure Devops ポータルを表示している Web ブラウザー ウィンドウで、新しいグループを選び、その **[アクセス許可]** タブを表示します。

1. そのグループに対する不要なアクセス許可を拒否します。たとえば、**[チーム プロジェクトの名前変更]**、**[作業項目を完全に削除]**、その他のアクセス許可 (エージェント プールに対してのみ使われる想定なので、そのグループに付与したくないもの) です。

   ![セキュリティ グループ設定を示すスクリーンショット。](media/security-group-settings.png)

   > [!IMPORTANT]
   > グループに付与したくないアクセス許可を残しておくと、エージェントで実行されているスクリプトまたはタスクは、グループのアクセス許可を使用して、実行してほしくないアクションを実行できます。

#### タスク 3:エージェント プールのアクセス許可を管理する

このタスクでは、エージェント プールのアクセス許可を管理します。

1. Azure Devops ポータルを表示している Web ブラウザー ウィンドウで、**eShopOnWeb** プロジェクトの **[プロジェクトの設定]** にある **[パイプライン]** セクションで **[エージェント プール]** を選びます。

1. **eShopOnWebSelfPool** エージェント プールを選びます。

1. エージェント プールの詳細ビューで、**[セキュリティ]** タブを選びます。

1. **[追加]** を選び、新しいグループ、**eShopOnWeb セキュリティ グループ**をエージェント プールのユーザーのアクセス許可に追加します。

1. エージェント プール閲覧者、ユーザー、管理者など、ユーザーまたはグループに適したロールを選びます。 この場合は、**ユーザー**を選びます。

1. **[追加]** を選んでアクセス許可を適用します。

   ![エージェント プールのセキュリティ構成を示すスクリーンショット。](media/agent-pool-security.png)

これで、パイプラインでエージェント プールを安全に使用する準備ができました。 エージェント プールの詳細については、「[エージェント プール](https://learn.microsoft.com/azure/devops/pipelines/agents/pools-queues)」をご覧ください。

### 演習 4:Azure と Azure DevOps リソースのクリーンアップを実行する

この演習では、このラボで作成した Azure DevOps リソースの一部を、ラボの後にクリーンアップします。

#### タスク 1:Azure VM を停止し、割り当てを解除する

> [!NOTE]
> このラボで作成した Azure VM は次のラボでも使うため、削除するのではなく、停止して割り当てを解除し、コンピューティング料金が発生しないようにします。

1. Azure portal で、このラボでデプロイした Azure VM **eshoponweb-vm** を表示するページに移動します

1. **eshoponweb-vm** Azure VM ページのツール バーで、**[停止]** を選んで停止し、割り当てを解除します。

#### タスク 2:Azure DevOps リソースを削除する

> [!NOTE]
> このラボで作成したセルフホステッド エージェントは次のラボで使うため、エージェントを削除するのではなく、構成に使った個人用アクセス トークンのみを失効させます。 こうすることで、後で実行できなくなります。

1. Azure DevOps ポータルの右側の上部メニュー (ユーザーのアバター アイコンのすぐ左) から **[ユーザー設定]** を選びます。

1. **[個人用アクセス トークン]** メニュー項目を選びます。

   ![[個人用アクセス トークン] メニューを示すスクリーンショット。](media/personal-access-token-menu.png)

1. **eShopOnWebToken** エントリを選びます。 

1. **[失効]** を選び、確認を求められたら、もう一度 **[失効]** を選びます。

## 確認

このラボでは、Azure DevOps セルフホステッド エージェントとエージェント プールを構成し、それらのプールのアクセス許可を管理する方法について学習します。 アクセス許可を効果的に管理することで、DevOps プロセスのセキュリティと整合性を維持しながら、適切なユーザーが必要なリソースにアクセスできるようにすることができます。
