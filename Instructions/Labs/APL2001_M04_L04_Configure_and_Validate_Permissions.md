---
lab:
  title: アクセス許可を構成して検証する
  module: 'Module 4: Configure and validate permissions'
---

# アクセス許可を構成して検証する

このラボでは、最小限の特権の原則に従ってセキュリティで保護された環境を設定し、メンバーがタスクを実行し、潜在的なセキュリティ リスクを最小限に抑えるために必要なリソースにのみ確実にアクセスできるようにします。 これには、ユーザーとパイプラインのアクセス許可の構成と検証、および Azure DevOps での承認とブランチ チェックの設定が含まれます。

この演習は約 **30** 分かかります。

## 開始する前に

ラボに従うには、Azure サブスクリプション、Azure DevOps 組織、eShopOnWeb アプリケーションが必要です。

- 手順に [従ってラボ環境](APL2001_M00_Validate_Lab_Environment.md)を検証します。
- 「セキュリティで保護されたパイプライン[用にエージェントとエージェント プールを構成する」または](/Instructions/Labs/APL2001_M03_L03_Configure_Agents_And_Agent_Pools_for_Secure_Pipelines.md)「セルフホステッド エージェントのインストール」の手順に[従って、セルフホステッド エージェントをインストールします](https://docs.microsoft.com/azure/devops/pipelines/agents/v2-windows?view=azure-devops#install)。

## 手順

### 演習 1: CI パイプラインをインポートし、パイプライン固有のアクセス許可を構成する

この演習では、eShopOnWeb アプリケーションの CI パイプラインをインポートして実行し、パイプライン固有のアクセス許可を構成します。

#### タスク 1: CI パイプラインをインポートして実行する

> [!NOTE]
> 別のラボで既に完了している場合は、インポートをスキップします。

まず、[eshoponweb-ci.yml](https://github.com/MicrosoftLearning/eShopOnWeb/blob/main/.ado/eshoponweb-ci.yml) という CI パイプラインをインポートします。

1. Azure DevOps ポータル `https://dev.azure.com` に移動し、組織を開きます。

1. eShopOnWeb** プロジェクトを**開きます。

1. **[パイプライン] > [パイプライン]** に移動します。

1. [新しいパイプライン **] ボタンを選択**します。

1. **[Azure Repos Git (Yaml)]** を選びます。

1. **eShopOnWeb** リポジトリを選びます。

1. **[既存の Azure Pipelines YAML ファイル]** を選びます。

1. **/.ado/eshoponweb-ci.yml** ファイルを選び、 **[続行]** をクリックします。

1. **[実行]** ボタンをクリックしてパイプラインを実行します。

1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、名前を変更しましょう。

1. Pipelines > Pipelines** に移動し**、最近作成したパイプラインを選択し、省略記号を選択して、[名前の変更/移動 **] オプションを選択**します。

1. **eshoponweb-ci** という名前を付け、 **[保存]** をクリックします。

### タスク 2: 特定のアクセス許可を使用してパイプラインを構成して実行する

このタスクでは、特定のエージェント プールで実行するように CI パイプラインを構成し、パイプラインを実行するためのアクセス許可を検証します。 パイプラインを編集し、エージェント プールにアクセス許可を追加するためのアクセス許可が必要です。

1. [プロジェクトの設定] に移動し、[パイプライン] の [エージェント プール] をクリックします。

1. 既定**のエージェント プールを**開きます。

1. **[セキュリティ]** タブを選びます。

1. エージェント プールに制限がない場合は、[アクセス許可**の制限] ボタンを選択**します。

    ![制限のないエージェント プールの [セキュリティ] タブのスクリーンショット。](media/agent-pool-security-no-restriction.png)

1. [ **追加]** ボタンを **選択し、eshoponweb-ci** パイプラインを選択して、エージェント プールにアクセスできるパイプラインの一覧に追加します。

1. **[実行]** を選択してパイプラインを実行します。

1. 進行中のパイプラインを開きます。 重要: [This pipeline needs permission to access resources before this run can continue to Docker Compose to ACI] (ACI への Docker Compose に対してこの実行を続けるには、まずこのパイプラインにリソースにアクセスするためのアクセス許可が必要です) というメッセージが表示された場合は、[表示]、[許可]、さらにもう一度 [許可] をクリックします。

パイプラインを正常に実行できる必要があります。

#### タスク 3: (完了した場合はスキップ) CD パイプラインを構成し、アクセス許可を検証する

> [!NOTE]
> 別のラボで既に完了している場合は、インポートをスキップします。

> [!IMPORTANT]
> アクセス許可がある場合は、パイプラインが実行中のパイプラインから直接実行することを許可**できます**。 アクセス許可がない場合は、管理アクセス許可を持つ別のアカウントを使用して、前のタスク 2 で説明したように特定のエージェントを使用してパイプラインを実行できるようにするか、エージェント プールにユーザーアクセス許可を追加する必要があります。

1. **[パイプライン] > [パイプライン]** に移動します。

1. [新しいパイプライン **] ボタンを選択**します。

1. **[Azure Repos Git (Yaml)]** を選びます。

1. **eShopOnWeb** リポジトリを選びます。

1. **[既存の Azure Pipelines YAML ファイル]** を選びます。

1. **/.ado/eshoponweb-cd-webapp-code.yml** ファイルを選んで、 **[続行]** をクリックします。

1. YAML パイプライン定義の変数セクションで、次をカスタマイズします。
   - **YOUR-SUBSCRIPTION-ID** を使用する Azure サブスクリプション ID にします。
   - **az400eshop-NAME**。グローバル一意の名前 (例: **eshoponweb-lab-YOURNAME**) を使用してデプロイする Web アプリ名。
   - **ユーザー設定の名前を持つ AZ400-EWebShop-NAME** (rg-eshoponweb** など**)。

1. 既定**の Microsoft ホステッド エージェント プールで Windows 最新**のイメージを**使用**するように YAML ファイルを更新します。 これを使用するには、pool** セクションを次の**値に設定します。

    ```yaml
    pool: 
      vmImage: windows-latest

    ```

1. **保存**を選択して、**実行**を選択します。

1. パイプラインを開くと、"このパイプラインには、この実行が Web アプリのデプロイを続行する前に、リソースにアクセスするためのアクセス許可が必要です" というメッセージが表示されます。 保留中のパイプライン実行を選択し、[表示] を選択します。

    ![[許可] ボタンを含むパイプラインのスクリーンショット。"](media/pipeline-permission-permit.png)

### 承認とブランチのチェックを構成して検証する

この演習では、CD パイプラインの承認と分岐チェックを構成して検証します。

#### タスク 1: 新しい環境を作成し、承認とチェックを追加する

1. パイプライン>環境**に**移動します。

1. **環境の作成**ボタンを選択します。

1. 環境にテスト**という名前を付け、リソースとして [なし]** を選択**し、[作成 **] を選択します**。**

1. [新しい環境] を選択**し、新しい環境**を作成し**、リソースとして [なし **] を選択**し、[作成 **] を選択します**。**

1. テスト**環境を**開き、[...*** ] を選択***し、[承認とチェックを選択**します**。

1. **[Approvals]** を選択します。

1. [承認者 **] **テキスト ボックスにユーザー名を入力し、別のユーザーがいる場合は追加して承認プロセスを検証します。

1. 手順に従**って、テスト**にデプロイを承認し、[作成 **] を選択**してください。

    ![手順を含む環境の承認のスクリーンショット。](media/add-environment-approvals.png)

1. [選択**+**] ボタンを選択し、[分岐コントロール **] を選択**し、[次へ **] を選択**します。

1. [許可された分岐] **フィールドで**、既定値のままにして [作成 **] を選択します**。 必要に応じて、アクションをさらに追加できます。

    ![メイン ブランチを含む環境ブランチ コントロールのスクリーンショット。](media/add-environment-branch-control.png)

1. 運用環境**を**開き、同じ手順を実行して承認とブランチ コントロールを追加します。 環境を区別するには、「運用環境**へのデプロイを承認して、refs/heads/メイン** ブランチを許可されたブランチに追加してください」の手順**を追加**します。

1. (省略可能)さらに環境を追加し、承認とブランチ制御を構成できます。 さらに、ユーザーまたはグループを環境に追加するようにセキュリティ**を構成**できます。
    - テスト環境を**開き、[...*** ] を選択***し、[セキュリティ] を選択します****。**
    - [追加] を選択**し、パイプラインを実行しているユーザーと、ロール*ユーザー*、作成者 *、* または*閲覧者を選択します*。**
    - **[追加]** を選択します。
    - **[保存]** を選択します。

#### タスク 2: 新しい環境を使用するように CD パイプラインを構成する

1. **[パイプライン] > [パイプライン]** に移動します。

1. **eshoponweb-cd-webapp-code** パイプラインを開きます。

1. **編集** を選択します。

1. **#download 成果物コメントの上に、次を**追加します。

    ```yaml
    stages:
    - stage: Test
      displayName: Testing WebApp
      jobs:
      - deployment: Test
        pool:
          vmImage: 'windows-latest'
        environment: Test
        strategy:
          runOnce:
            deploy:
              steps:
              - script: echo Hello world! Testing environments!
    - stage: Deploy
    displayName: Deploy to WebApp
      jobs:
      - deployment: Deploy
        pool: 
          vmImage: windows-latest
        environment: Production
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
    ```

    > [!NOTE]
    > YAML インデント ルールが満たされていることを確認するには、6 つのスペースの上にあるコードの行を右にシフトする必要があります。

    パイプラインは次のようになっているはずです。

    ![[配置パイプライン] ページのスクリーンショット。](media/pipeline-add-yaml-deployment.png)

1. [保存および実行] を選択します。

1. パイプラインを開くと、"このパイプラインには、この実行を WebApp のテストに続行する前に、リソースにアクセスするためのアクセス許可が必要です" というメッセージが表示されます。 [表示]**、[許可]、**および **[許可****] をもう一度選択**します。

    ![パイプラインの実行を承認する許可ボタンが表示されたパイプラインのスクリーンショット。"](media/pipeline-environment-permit.png)

1. WebApp のテスト ステージを**開くと、この実行を引き続き WebApp**** のテストに進める前に、レビューが必要なメッセージ **1 が表示されます。 [確認] を選択**し、[承認] を選択します****。**

    ![テスト ステージが承認されるパイプラインのスクリーンショット。"](media/pipeline-test-environment-approve.png)

1. パイプラインが完了するまで待ち、パイプライン ログを開き、テスト WebApp** ステージが**正常に実行されたことをチェックします。

    !["Testing WebApp ステージが正常に実行されたパイプライン ログのスクリーンショット"。](media/pipeline-test-environment-success.png)

1. パイプラインに戻ると、承認を待つ WebApp** へのデプロイステージ**が表示されます。 [WebApp** のテスト] ステージで、前と同じように [確認**と****承認**] を選択**します。

1. パイプラインが完了するまで、WebApp** へのデプロイ ステージが正常に実行されたことをチェック**します。

    ![[Deploy to WebApp]\(WebApp へのデプロイ\) ステージが承認されているパイプラインのスクリーンショット。"](media/pipeline-deploy-environment-success.png)

テストと運用の両方の環境で、承認とブランチ チェックを使用してパイプラインを正常に実行できる必要があります。

### 演習 3: ラボで使用されているリソースを削除する

1. Azure portal で、作成したリソース グループを開き、 **[リソース グループの削除]** をクリックします。

    ![[リソース グループ削除] ボタンのスクリーンショット。](media/delete-resource-group.png)

    > [!WARNING]
    > 新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 使用していないリソースを削除することで、予期しない料金が発生しなくなります。

1. このラボの Azure DevOps 組織とプロジェクトに追加した特定のアクセス許可をリセットします。

## 確認

このラボでは、最小限の特権の原則に従ってセキュリティで保護された環境を設定し、メンバーがタスクを実行し、潜在的なセキュリティ リスクを最小限に抑えるために必要なリソースにのみ確実にアクセスできるようにします。 これには、ユーザーとパイプラインのアクセス許可の構成と検証、および Azure DevOps での承認とブランチ チェックの設定が含まれます。
